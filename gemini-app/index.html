<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹æ‰‹ã«ã‹ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¡ã‚ƒã£ãŸå›</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Zen+Kaku+Gothic+New&display=swap');

        body {
            font-family: 'Zen Kaku Gothic New', sans-serif;
            background-color: #ffe4e6;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 2rem;
            box-shadow: 0 10px 30px rgba(255, 182, 193, 0.5);
            padding: 2.5rem;
        }
        .btn {
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            font-weight: bold;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            background-image: linear-gradient(to right, #ff9a9e, #fad0c4);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.7);
        }
        .btn-collection {
            background-image: linear-gradient(to right, #84fab0, #8fd3f4);
        }
        .btn-collection:hover {
             box-shadow: 0 4px 15px rgba(132, 250, 176, 0.7);
        }
        .grade-select {
            appearance: none;
            background-color: #fff8f8;
            border: 2px solid #ffb6c1;
            border-radius: 1.5rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .grade-select:hover {
            background-color: #ffebeb;
        }
        .textarea-custom {
            resize: none;
            height: 200px;
            border-radius: 1.5rem;
            border: 2px solid #ffb6c1;
            background-color: #fff8f8;
        }
        .feedback-box {
            border-radius: 2rem;
            padding: 2rem;
            margin-top: 1.5rem;
        }
        .score-S { background-color: #d1fae5; color: #065f46; }
        .score-A { background-color: #dbeafe; color: #1e40af; }
        .score-B { background-color: #fef3c7; color: #92400e; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ff69b4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.is-visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }
        .collection-card {
            background-color: #f0fff4;
            border: 2px solid #84fab0;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: left;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .collection-word {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2f855a;
            font-family: 'Mochiy Pop One', sans-serif;
        }
        .collection-context {
            margin-top: 0.5rem;
            color: #4a5568;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="bg-pink-50 min-h-screen flex items-center justify-center">

<div class="container">
    <div class="card">
        <h1 class="text-4xl font-extrabold text-center text-pink-500 mb-2 font-['Mochiy_Pop_One']">
            <span class="inline-block transform -rotate-12">ğŸ‰</span>
            <span class="inline-block transform rotate-6">å‹æ‰‹ã«ã‹ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¡ã‚ƒã£ãŸå›</span>
            <span class="inline-block transform rotate-12">ğŸ“</span>
        </h1>
        <p class="text-center text-gray-500 mb-8 whitespace-nowrap" id="header-text"></p>

        <!-- å­¦å¹´é¸æŠã¨æ–‡ç« å…¥åŠ› -->
        <div class="space-y-6">
            <div>
                <label for="grade-select" class="block text-gray-700 font-bold mb-2" id="grade-label"></label>
                <select id="grade-select" class="w-full grade-select focus:ring-2 focus:ring-pink-300 focus:border-pink-300">
                    <option value="1">1å¹´ç”Ÿ</option>
                    <option value="2">2å¹´ç”Ÿ</option>
                    <option value="3">3å¹´ç”Ÿ</option>
                    <option value="4">4å¹´ç”Ÿ</option>
                    <option value="5">5å¹´ç”Ÿ</option>
                    <option value="6">6å¹´ç”Ÿ</option>
                </select>
            </div>
            <div>
                <label for="text-input" class="block text-gray-700 font-bold mb-2" id="text-label"></label>
                <textarea id="text-input" class="w-full p-4 border rounded-lg textarea-custom focus:ring-2 focus:ring-pink-300 focus:border-pink-300" placeholder="ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="analyze-button" class="btn bg-pink-400 text-white hover:bg-pink-500 flex items-center justify-center w-full sm:w-auto">
                    ã“ã“ã§ãƒã‚§ãƒƒã‚¯ï¼
                </button>
                <button id="collection-button" class="btn btn-collection flex items-center justify-center w-full sm:w-auto">
                    ã‚­ãƒ©ã‚­ãƒ©ãƒ¯ãƒ¼ãƒ‰ãƒ»ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
                </button>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="result-area" class="mt-8 hidden">
            <h2 class="text-2xl font-bold text-center text-pink-500 mb-4">â‘¢ çµæœã ã‚ˆï¼</h2>
            <div id="feedback-content" class="feedback-box">
                <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>
</div>

<!-- ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="collection-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="text-2xl font-bold mb-6 text-green-600 font-['Mochiy_Pop_One']">ã‚­ãƒ©ã‚­ãƒ©ãƒ¯ãƒ¼ãƒ‰ãƒ»ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h3>
        <div id="collection-grid" class="space-y-4">
            <!-- ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>
        <button id="close-collection-modal" class="mt-8 px-6 py-2 bg-gray-400 text-white rounded-full hover:bg-gray-500 transition">ã¨ã˜ã‚‹</button>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const analyzeButton = document.getElementById('analyze-button');
        const gradeSelect = document.getElementById('grade-select');
        const textInput = document.getElementById('text-input');
        const resultArea = document.getElementById('result-area');
        const feedbackContent = document.getElementById('feedback-content');
        const headerText = document.getElementById('header-text');
        const gradeLabel = document.getElementById('grade-label');
        const textLabel = document.getElementById('text-label');
        
        const collectionButton = document.getElementById('collection-button');
        const collectionModal = document.getElementById('collection-modal');
        const closeCollectionModalButton = document.getElementById('close-collection-modal');
        const collectionGrid = document.getElementById('collection-grid');

        const curriculumContent = `
            # å°å­¦æ ¡å­¦ç¿’æŒ‡å°è¦é ˜(å¹³æˆ29å¹´å‘Šç¤º)è§£èª¬ å›½èªç·¨
            ## è‚²æˆã‚’ç›®æŒ‡ã™è³‡è³ªãƒ»èƒ½åŠ›
            è¨€è‘‰ã«ã‚ˆã‚‹è¦‹æ–¹ãƒ»è€ƒãˆæ–¹ã‚’åƒã‹ã›ï¼Œè¨€èªæ´»å‹•ã‚’é€šã—ã¦ï¼Œå›½èªã§æ­£ç¢ºã«ç†è§£ã—é©åˆ‡ã«è¡¨ç¾ã™ã‚‹è³‡è³ªãƒ» èƒ½åŠ›ã‚’è‚²æˆã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã™ã€‚
            ## ç¬¬1å­¦å¹´åŠã³ç¬¬2å­¦å¹´ã®å†…å®¹
            ### æ›¸ãã“ã¨
            â‘´ çµŒé¨“ã—ãŸã“ã¨ã‚„æƒ³åƒã—ãŸã“ã¨ãªã©ã‹ã‚‰æ›¸ãã“ã¨ã‚’è¦‹ä»˜ã‘ï¼Œå¿…è¦ãªäº‹æŸ„ã‚’é›†ã‚ãŸã‚Šç¢ºã‹ã‚ãŸã‚Šã—ã¦ï¼Œä¼ãˆãŸã„ã“ã¨ã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨ã€‚
            â‘µ è‡ªåˆ†ã®æ€ã„ã‚„è€ƒãˆãŒæ˜ç¢ºã«ãªã‚‹ã‚ˆã†ã«ï¼Œäº‹æŸ„ã®é †åºã«æ²¿ã£ã¦ç°¡å˜ãªæ§‹æˆã‚’è€ƒãˆã‚‹ã“ã¨ã€‚
            â‘¶ èªã¨èªã‚„æ–‡ã¨æ–‡ã¨ã®ç¶šãæ–¹ã«æ³¨æ„ã—ãªãŒã‚‰ï¼Œå†…å®¹ã®ã¾ã¨ã¾ã‚ŠãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«æ›¸ãè¡¨ã—æ–¹ã‚’å·¥å¤«ã™ã‚‹ã“ã¨ã€‚
            â‘· æ–‡ç« ã‚’èª­ã¿è¿”ã™ç¿’æ…£ã‚’ä»˜ã‘ã‚‹ã¨ã¨ã‚‚ã«ï¼Œé–“é•ã„ã‚’æ­£ã—ãŸã‚Šï¼Œèªã¨èªã‚„æ–‡ã¨æ–‡ã¨ã®ç¶šãæ–¹ã‚’ç¢ºã‹ã‚ãŸã‚Šã™ã‚‹ã“ã¨ã€‚
            â‘¸ æ–‡ç« ã«å¯¾ã™ã‚‹æ„Ÿæƒ³ã‚’ä¼ãˆåˆã„ï¼Œè‡ªåˆ†ã®æ–‡ç« ã®å†…å®¹ã‚„è¡¨ç¾ã®ã‚ˆã„ã¨ã“ã‚ã‚’è¦‹ä»˜ã‘ã‚‹ã“ã¨ã€‚
            ## ç¬¬3å­¦å¹´åŠã³ç¬¬4å­¦å¹´ã®å†…å®¹
            ### æ›¸ãã“ã¨
            â‘´ ç›¸æ‰‹ã‚„ç›®çš„ã‚’æ„è­˜ã—ã¦ï¼ŒçµŒé¨“ã—ãŸã“ã¨ã‚„æƒ³åƒã—ãŸã“ã¨ãªã©ã‹ã‚‰æ›¸ãã“ã¨ã‚’é¸ã³ï¼Œé›†ã‚ãŸææ–™ã‚’æ¯”è¼ƒã—ãŸã‚Šåˆ†é¡ã—ãŸã‚Šã—ã¦ï¼Œä¼ãˆãŸã„ã“ã¨ã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨ã€‚
            â‘µ æ›¸ãå†…å®¹ã®ä¸­å¿ƒã‚’æ˜ç¢ºã«ã—ï¼Œå†…å®¹ã®ã¾ã¨ã¾ã‚Šã§æ®µè½ã‚’ã¤ãã£ãŸã‚Šã€æ®µè½ç›¸äº’ã®é–¢ä¿‚ã«æ³¨æ„ã—ãŸã‚Šã—ã¦ï¼Œæ–‡ç« ã®æ§‹æˆã‚’è€ƒãˆã‚‹ã“ã¨ã€‚
            â‘¶ è‡ªåˆ†ã®è€ƒãˆã¨ãã‚Œã‚’æ”¯ãˆã‚‹ç†ç”±ã‚„äº‹ä¾‹ã¨ã®é–¢ä¿‚ã‚’æ˜ç¢ºã«ã—ã¦ï¼Œæ›¸ãè¡¨ã—æ–¹ã‚’å·¥å¤«ã™ã‚‹ã“ã¨ã€‚
            â‘· æ–‡ç« ã‚’èª­ã¿è¿”ã—ï¼Œèª¤å­—ãƒ»è„±å­—ã‚’æ­£ã—ãŸã‚Šï¼Œèªå¥ã®ç”¨æ³•ã‚’ç¢ºã‹ã‚ãŸã‚Šã™ã‚‹ã“ã¨ã€‚
            â‘¸ æ–‡ç« ã«å¯¾ã™ã‚‹è³ªå•ã‚„æ„Ÿæƒ³ã‚’ä¼ãˆåˆã„ï¼Œè¡¨ç¾ã®ä»•æ–¹ã«ã¤ã„ã¦è©±ã—åˆã†ã“ã¨ã€‚
            ## ç¬¬5å­¦å¹´åŠã³ç¬¬6å­¦å¹´ã®å†…å®¹
            ### æ›¸ãã“ã¨
            â‘´ ç›®çš„ã‚„æ„å›³ã«å¿œã˜ã¦ï¼Œæ„Ÿã˜ãŸã“ã¨ã‚„è€ƒãˆãŸã“ã¨ãªã©ã‹ã‚‰æ›¸ãã“ã¨ã‚’é¸ã³ï¼Œé›†ã‚ãŸææ–™ã‚’åˆ†é¡ã—ãŸã‚Šé–¢ä¿‚ä»˜ã‘ãŸã‚Šã—ã¦ï¼Œä¼ãˆãŸã„ã“ã¨ã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨ã€‚
            â‘µ ç­‹é“ã®é€šã£ãŸæ–‡ç« ã¨ãªã‚‹ã‚ˆã†ã«ï¼Œæ–‡ç« å…¨ä½“ã®æ§‹æˆã‚„å±•é–‹ã‚’è€ƒãˆã‚‹ã“ã¨ã€‚
            â‘¶ ç›®çš„ã‚„æ„å›³ã«å¿œã˜ã¦ç°¡å˜ã«æ›¸ã„ãŸã‚Šè©³ã—ãæ›¸ã„ãŸã‚Šã™ã‚‹ã¨ã¨ã‚‚ã«ï¼Œäº‹å®Ÿã¨æ„Ÿæƒ³ï¼Œæ„è¦‹ã¨ã‚’åŒºåˆ¥ã—ã¦æ›¸ã„ãŸã‚Šã™ã‚‹ãªã©ï¼Œè‡ªåˆ†ã®è€ƒãˆãŒä¼ã‚ã‚‹ã‚ˆã†ã«æ›¸ãè¡¨ã—æ–¹ã‚’å·¥å¤«ã™ã‚‹ã“ã¨ã€‚
            â‘· æ–‡ç« ã‚’èª­ã¿è¿”ã—ï¼Œè¡¨ç¾ã®ä»•æ–¹ã«ã¤ã„ã¦è¦‹ç›´ã™ã“ã¨ã€‚
            â‘¸ æ–‡ç« ã«å¯¾ã™ã‚‹æ„è¦‹ã‚„è³ªå•ã‚’ä¼ãˆåˆã„ï¼Œè‡ªåˆ†ã®æ–‡ç« ã‚’å®¢è¦³çš„ã«è¦‹ã¤ã‚ã‚‹ã“ã¨ã€‚
        `;
        
        const shortTextFeedbackExamples = {
            '1': [ "ãã‚‡ã†ã€ã“ã†ãˆã‚“ã§ãƒ–ãƒ©ãƒ³ã‚³ã«ã®ã£ãŸã‚‰ã€ãã‚‰ã‚’ã¨ã‚“ã§ã‚‹ã¿ãŸã„ã§ãŸã®ã—ã‹ã£ãŸã€‚", "ãã‚‡ã†ã€ã‹ããã¨ã„ã£ã—ã‚‡ã«ã‚«ãƒ¬ãƒ¼ã‚’ã¤ãã£ãŸã‚ˆã€‚ã¾ãœã‚‹ã®ãŒãŸã®ã—ã‹ã£ãŸã€‚", "ãã‚‡ã†ã€ã›ã‚“ã›ã„ã«ã»ã‚ã‚‰ã‚Œã¦ã€ã™ã”ãã†ã‚Œã—ã‹ã£ãŸã‚ˆã€‚", "ãŠã‚‚ã¡ã‚ƒã®ãã‚‹ã¾ãŒã“ã‚ã‚Œã¦ã—ã¾ã£ã¦ã€ã‹ãªã—ã‹ã£ãŸ.", "ã«ã‚“ãã‚‡ã†ã®ãŠã¿ã›ã«ã„ã£ãŸã‚‰ã€ã»ã—ã‹ã£ãŸã‚‚ã®ãŒãœã‚“ã¶ã†ã‚Šãã‚Œã§ã€ãŠã“ã£ãŸã€‚", "ãã‚‡ã†ã®ã‚ã•ã¯ã€ã¨ã¦ã‚‚ã•ã‚€ãã¦ã¤ã‚‰ã‹ã£ãŸã‚ˆã€‚ã¯ã‚„ãã‚ã£ãŸã‹ããªã‚‰ãªã„ãªã€‚" ],
            '2': [ "ãã‚‡ã†ã€ã“ã†ãˆã‚“ã§ãƒ–ãƒ©ãƒ³ã‚³ã«ã®ã£ãŸã‚‰ã€ãã‚‰ã‚’ã¨ã‚“ã§ã„ã‚‹ã¿ãŸã„ã§ã€ã¨ã¦ã‚‚ãŸã®ã—ã‹ã£ãŸã‚ˆã€‚", "ãã‚‡ã†ã€ã‹ããã¨ã„ã£ã—ã‚‡ã«ã‚«ãƒ¬ãƒ¼ã‚’ã¤ãã£ãŸã‚ˆã€‚ã¾ãœã‚‹ã®ãŒã¨ã¦ã‚‚ãŸã®ã—ã‹ã£ãŸã€‚", "ãã‚‡ã†ã€ã›ã‚“ã›ã„ã«ã»ã‚ã‚‰ã‚Œã¦ã€ã¨ã¦ã‚‚ã†ã‚Œã—ã‹ã£ãŸã‚ˆã€‚", "ãŠã‚‚ã¡ã‚ƒã®ãã‚‹ã¾ãŒã“ã‚ã‚Œã¦ã—ã¾ã£ã¦ã€ã¨ã¦ã‚‚ã‹ãªã—ã‹ã£ãŸã€‚ã©ã†ã‚„ã£ã¦ãªãŠãã†ã‹ãªã€‚", "ã«ã‚“ãã‚‡ã†ã®ãŠã¿ã›ã«ã„ã£ãŸã‚‰ã€ã»ã—ã‹ã£ãŸã‚‚ã®ãŒãœã‚“ã¶ã†ã‚Šãã‚Œã§ã€ã¨ã¦ã‚‚ãŠã“ã£ãŸã€‚", "ãã‚‡ã†ã®ã‚ã•ã¯ã€ã¨ã¦ã‚‚ã•ã‚€ãã¦ã¤ã‚‰ã‹ã£ãŸã€‚ã¯ã‚„ãã‚ã£ãŸã‹ããªã‚‰ãªã„ã‹ãªã€‚" ],
            '3': [ "ä»Šæ—¥ã®é è¶³ã¯ã¨ã¦ã‚‚æ¥½ã—ã‹ã£ãŸã€‚ãŠå¼å½“ãŒãŠã„ã—ã‹ã£ãŸã—ã€ã¿ã‚“ãªã¨éŠã¶ã®ã‚‚é¢ç™½ã‹ã£ãŸã€‚", "å¼ŸãŒã²ã‚‰ãŒãªã‚’ã‹ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã€ã¨ã¦ã‚‚ã†ã‚Œã—ã‹ã£ãŸã€‚ä½•åº¦ã‚‚ç·´ç¿’ã—ãŸã®ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹ã‚‰ã€‚", "ã ã„ã™ãã ã£ãŸãƒãƒ ã‚¹ã‚¿ãƒ¼ãŒæ­»ã‚“ã§ã—ã¾ã£ã¦ã€ã¨ã¦ã‚‚ã‹ãªã—ã‹ã£ãŸã€‚ã‚‚ã†ä¼šãˆãªã„ã¨æ€ã†ã¨æ¶™ãŒå‡ºãŸã€‚", "å‹é”ãŒç´„æŸã‚’ç ´ã£ãŸã‹ã‚‰ã€ãŠã“ã£ãŸã€‚ã‚‚ã†ä¸€ç·’ã«éŠã°ãªã„ã¨æ€ã£ãŸã‘ã©ã€ã¡ã‚ƒã‚“ã¨è¬ã£ã¦ãã‚ŒãŸã‹ã‚‰ã‚†ã‚‹ã—ãŸã€‚", "ä»Šæ—¥ã‚ã£ãŸãƒ†ã‚¹ãƒˆãŒã¨ã¦ã‚‚é›£ã—ãã¦ã€ã¤ã‚‰ã‹ã£ãŸã€‚ã‚‚ã†å‹‰å¼·ã—ãŸããªã„ã¨æ€ã£ãŸã‘ã©ã€ãŒã‚“ã°ã‚‹ã—ã‹ãªã„ã€‚", "æœèµ·ãã¦ã™ãã«è¶³ãŒã„ãŸãã¦ã¤ã‚‰ã‹ã£ãŸã€‚æ­©ãã®ãŒã¤ã‚‰ã„ã®ã§å­¦æ ¡ã‚’ä¼‘ã‚‚ã†ã‹ã¨è€ƒãˆãŸã€‚" ],
            '4': [ "ä»Šæ—¥ã®é è¶³ã¯ã¨ã¦ã‚‚æ¥½ã—ã‹ã£ãŸã€‚ãŠå¼å½“ãŒãŠã„ã—ã‹ã£ãŸã—ã€ã¿ã‚“ãªã¨éŠã¶ã®ã‚‚é¢ç™½ã‹ã£ãŸã€‚", "å¼ŸãŒã²ã‚‰ãŒãªã‚’ã‹ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã€ã¨ã¦ã‚‚ã†ã‚Œã—ã‹ã£ãŸã€‚ä½•åº¦ã‚‚ç·´ç¿’ã—ãŸã®ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹ã‚‰ã€‚", "ã ã„ã™ãã ã£ãŸãƒãƒ ã‚¹ã‚¿ãƒ¼ãŒæ­»ã‚“ã§ã—ã¾ã£ã¦ã€ã¨ã¦ã‚‚ã‹ãªã—ã‹ã£ãŸã€‚ã‚‚ã†ä¼šãˆãªã„ã¨æ€ã†ã¨æ¶™ãŒå‡ºãŸã€‚", "å‹é”ãŒç´„æŸã‚’ç ´ã£ãŸã‹ã‚‰ã€ãŠã“ã£ãŸã€‚ã‚‚ã†ä¸€ç·’ã«éŠã°ãªã„ã¨æ€ã£ãŸã‘ã©ã€ã¡ã‚ƒã‚“ã¨è¬ã£ã¦ãã‚ŒãŸã‹ã‚‰ã‚†ã‚‹ã—ãŸ.", "ä»Šæ—¥ã‚ã£ãŸãƒ†ã‚¹ãƒˆãŒã¨ã¦ã‚‚é›£ã—ãã¦ã€ã¤ã‚‰ã‹ã£ãŸã€‚ã‚‚ã†å‹‰å¼·ã—ãŸããªã„ã¨æ€ã£ãŸã‘ã©ã€ãŒã‚“ã°ã‚‹ã—ã‹ãªã„ã€‚", "æœèµ·ãã¦ã™ãã«è¶³ãŒã„ãŸãã¦ã¤ã‚‰ã‹ã£ãŸã€‚æ­©ãã®ãŒã¤ã‚‰ã„ã®ã§å­¦æ ¡ã‚’ä¼‘ã‚‚ã†ã‹ã¨è€ƒãˆãŸã€‚" ],
            '5': [ "ä»Šæ—¥ã®é è¶³ã¯ã¨ã¦ã‚‚æ¥½ã—ã‹ã£ãŸã€‚ãŠå¼å½“ãŒãŠã„ã—ã‹ã£ãŸã—ã€å‹é”ã¨éŠã¶ã®ã‚‚é¢ç™½ã‹ã£ãŸã€‚", "å¼ŸãŒã²ã‚‰ãŒãªã‚’ã‹ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã€ã¨ã¦ã‚‚ã†ã‚Œã—ã‹ã£ãŸã€‚ä½•åº¦ã‚‚ç·´ç¿’ã—ãŸã®ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹ã‚‰ã€‚", "ã ã„ã™ãã ã£ãŸãƒãƒ ã‚¹ã‚¿ãƒ¼ãŒæ­»ã‚“ã§ã—ã¾ã£ã¦ã€ã¨ã¦ã‚‚ã‹ãªã—ã‹ã£ãŸã€‚ã‚‚ã†ä¼šãˆãªã„ã¨æ€ã†ã¨æ¶™ãŒå‡ºãŸã€‚", "å‹é”ãŒç´„æŸã‚’ç ´ã£ãŸã‹ã‚‰ã€ãŠã“ã£ãŸã€‚ã‚‚ã†ä¸€ç·’ã«éŠã°ãªã„ã¨æ€ã£ãŸã‘ã©ã€ã¡ã‚ƒã‚“ã¨è¬ã£ã¦ãã‚ŒãŸã‹ã‚‰ã‚†ã‚‹ã—ãŸã€‚", "ä»Šæ—¥ã‚ã£ãŸãƒ†ã‚¹ãƒˆãŒã¨ã¦ã‚‚é›£ã—ãã¦ã€ã¤ã‚‰ã‹ã£ãŸã€‚ã‚‚ã†å‹‰å¼·ã—ãŸããªã„ã¨æ€ã£ãŸã‘ã©ã€ãŒã‚“ã°ã‚‹ã—ã‹ãªã„ã€‚", "æœèµ·ãã¦ã™ãã«è¶³ãŒã„ãŸãã¦ã¤ã‚‰ã‹ã£ãŸã€‚æ­©ãã®ãŒã¤ã‚‰ã„ã®ã§å­¦æ ¡ã‚’ä¼‘ã‚‚ã†ã‹ã¨è€ƒãˆãŸã€‚" ],
            '6': [ "ä»Šæ—¥ã®é è¶³ã¯ã¨ã¦ã‚‚æ¥½ã—ã‹ã£ãŸã€‚ãŠå¼å½“ãŒãŠã„ã—ã‹ã£ãŸã—ã€å‹é”ã¨éŠã¶ã®ã‚‚é¢ç™½ã‹ã£ãŸã€‚", "å¼ŸãŒã²ã‚‰ãŒãªã‚’ã‹ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã€ã¨ã¦ã‚‚ã†ã‚Œã—ã‹ã£ãŸã€‚ä½•åº¦ã‚‚ç·´ç¿’ã—ãŸã®ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹ã‚‰ã€‚", "ã ã„ã™ãã ã£ãŸãƒãƒ ã‚¹ã‚¿ãƒ¼ãŒæ­»ã‚“ã§ã—ã¾ã£ã¦ã€ã¨ã¦ã‚‚ã‹ãªã—ã‹ã£ãŸã€‚ã‚‚ã†ä¼šãˆãªã„ã¨æ€ã†ã¨æ¶™ãŒå‡ºãŸã€‚", "å‹é”ãŒç´„æŸã‚’ç ´ã£ãŸã‹ã‚‰ã€ãŠã“ã£ãŸã€‚ã‚‚ã†ä¸€ç·’ã«éŠã°ãªã„ã¨æ€ã£ãŸã‘ã©ã€ã¡ã‚ƒã‚“ã¨è¬ã£ã¦ãã‚ŒãŸã‹ã‚‰ã‚†ã‚‹ã—ãŸã€‚", "ä»Šæ—¥ã‚ã£ãŸãƒ†ã‚¹ãƒˆãŒã¨ã¦ã‚‚é›£ã—ãã¦ã€ã¤ã‚‰ã‹ã£ãŸã€‚ã‚‚ã†å‹‰å¼·ã—ãŸããªã„ã¨æ€ã£ãŸã‘ã©ã€ãŒã‚“ã°ã‚‹ã—ã‹ãªã„ã€‚", "æœèµ·ãã¦ã™ãã«è¶³ãŒã„ãŸãã¦ã¤ã‚‰ã‹ã£ãŸã€‚æ­©ãã®ãŒã¤ã‚‰ã„ã®ã§å­¦æ ¡ã‚’ä¼‘ã‚‚ã†ã‹ã¨è€ƒãˆãŸã€‚" ]
        };

        const examplePrompts = {
            'happy': "æ¥½ã—ã‹ã£ãŸã“ã¨ã‚„ã†ã‚Œã—ã‹ã£ãŸã“ã¨", 'sad': "ã‹ãªã—ã‹ã£ãŸã“ã¨ã‚„ã¤ã‚‰ã‹ã£ãŸã“ã¨", 'angry': "ãŠã“ã£ãŸã“ã¨ã‚„è…¹ãŒç«‹ã£ãŸã“ã¨", 'experience': "çµŒé¨“ã—ãŸã“ã¨ã‚„å­¦ã‚“ã ã“ã¨"
        };
        
        const inappropriateKeywords = ['å‡¡äºº', 'ãƒ€ãƒ¡', 'è²´æ§˜', 'è‹¦ã—ã‚ã‚‹', 'æ®ºã™', 'æ­»ã­', 'ãƒã‚«', 'ã‚¢ãƒ›', 'å£²æ˜¥', 'æ€§', 'ãƒ¬ã‚¤ãƒ—', 'ã‚»ãƒƒã‚¯ã‚¹', 'ãƒãƒ«ãƒ', 'ãã', 'ã¡ã‚“ã“', 'ã¾ã‚“ã“', 'ãŠã£ã±ã„'];

        function getRandomExamplePrompt() {
            const keys = Object.keys(examplePrompts);
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            return examplePrompts[randomKey];
        }

        function sanitizeInput(text) {
            const cleanText = text.replace(/[^ã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾ ãƒ¼a-zA-Z0-9\s.,?!ã€‚ã€ï¼ï¼Ÿ]/g, '');
            return cleanText.trim();
        }

        function containsInappropriateContent(text) {
            const lowerCaseText = text.toLowerCase();
            return inappropriateKeywords.some(keyword => lowerCaseText.includes(keyword));
        }

        function updateText() {
            headerText.innerHTML = "ã•ãã€ã¿ã‚“ãªã§æ–‡ç« æ›¸ã‘ã‚‹äººã‚’ç›®ã–ãã†ï¼";
            gradeLabel.innerHTML = "â‘  è‡ªåˆ†ã®å­¦å¹´ã‚’å…¥åŠ›ã—ã‚ˆã†ï¼";
            textLabel.innerHTML = `â‘¡ ã‚¢ãƒ—ãƒªã«è‡ªåˆ†ã®æ›¸ã„ãŸæ–‡ç« ã‚’å…¥åŠ›ã—ã‚ˆã†ï¼`;
        }
        
        function showMessage(message, title = "ã‚ã‚Œã‚Œï¼Ÿ") {
            const existingBox = document.querySelector('.message-modal-overlay');
            if(existingBox) {
                existingBox.remove();
            }

            const messageBox = document.createElement('div');
            messageBox.className = 'modal-overlay message-modal-overlay';
            messageBox.innerHTML = `
                <div class="modal-content" style="width: 400px;">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <p>${message}</p>
                    <button class="mt-6 px-6 py-2 bg-pink-500 text-white rounded-full hover:bg-pink-600 transition">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            
            messageBox.querySelector('button').addEventListener('click', () => {
                messageBox.classList.remove('is-visible');
                setTimeout(() => {
                    messageBox.remove();
                }, 300);
            });

            setTimeout(() => {
                 messageBox.classList.add('is-visible');
            }, 10);
        }
        
        updateText();
        gradeSelect.addEventListener('change', updateText);
        
        analyzeButton.addEventListener('click', async () => {
            const grade = gradeSelect.value;
            const originalText = textInput.value;
            const text = sanitizeInput(originalText);

            if (text === '') {
                showMessage("æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„ã‚ˆã€‚ä½•ã‹æ›¸ã„ã¦ã¿ã‚ˆã†ï¼");
                return;
            }

            if (containsInappropriateContent(text)) {
                const inappropriateFeedback = {
                    score: "B",
                    evaluation: "ãã®è¨€è‘‰ã¯è©•ä¾¡ã§ãã¾ã›ã‚“ã€‚",
                    encouragement: "å…ˆç”Ÿã¯ã€ã‚ãªãŸãŒä¸€ç”Ÿæ‡¸å‘½æ–‡ç« ã‚’æ›¸ã„ã¦ãã‚Œã¦ã„ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã€‚",
                    next_step: "è¨€è‘‰ã«ã¯ã€ã ã‚Œã‹ã‚’å…ƒæ°—ã¥ã‘ãŸã‚Šã€å„ªã—ã„æ°—æŒã¡ã«ã•ã›ã‚‹åŠ›ãŒã‚ã‚Šã¾ã™ã€‚ä»Šåº¦ã¯ã€ãã‚“ãªè¨€è‘‰ã‚’é¸ã‚“ã§ã€å¿ƒæ¸©ã¾ã‚‹æ–‡ç« ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†ã­ã€‚",
                    examples: [],
                    kirakira_words: []
                };
                displayFeedback(inappropriateFeedback, text);
                return;
            }
            
            if (text.length < 10) {
                const shortTextExamples = shortTextFeedbackExamples[grade];
                const examples = [];
                for (let i = 0; i < 2; i++) {
                    const randomIndex = Math.floor(Math.random() * shortTextExamples.length);
                    examples.push(`ãŸã¨ãˆã°ã“ã‚“ãªæ–‡ï¼š${shortTextExamples[randomIndex]}`);
                }
                const shortTextFeedback = {
                    score: "B",
                    evaluation: "ã¾ã ã¡ã‚‡ã£ã¨çŸ­ã„æ–‡ç« ã ã­ã€‚ã‚‚ã£ã¨ãã‚ã—ãæ›¸ã„ã¦ã¿ã‚ˆã†ï¼",
                    encouragement: "æ–‡å­—ã‚’ã‹ãã®ãŒã˜ã‚‡ã†ãšã ã­ï¼",
                    next_step: "ãªã«ãŒã‚ã£ãŸã®ã‹ã‚’ã€ã‚‚ã£ã¨ãã‚ã—ãã‹ã„ã¦ã¿ã‚ˆã†ã€‚",
                    examples: examples,
                    kirakira_words: []
                };
                displayFeedback(shortTextFeedback, text);
                return;
            }
            
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = `<span class="spinner"></span> <span class="text-xs">è©•ä¾¡ä¸­...</span>`;

            try {
                // â˜…â˜…â˜… AIã¸ã®æŒ‡ç¤ºã‚’ä¿®æ­£ â˜…â˜…â˜…
                const prompt = `ã‚ãªãŸã¯å­¦æ ¡ã®å…ˆç”Ÿã§ã™ã€‚ä»¥ä¸‹ã®æŒ‡ç¤ºã¨å‚è€ƒè³‡æ–™ã‚’åŸºã«ã€å­ä¾›ã®æ–‡ç« ã‚’è©•ä¾¡ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
                
                # æŒ‡ç¤º
                1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œå­¦å¹´ã€ã¨ã€Œæ–‡ç« ã€ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
                2. å‚è€ƒè³‡æ–™ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã€é¸æŠã•ã‚ŒãŸå­¦å¹´ã®ã€Œæ›¸ãã“ã¨ã€ã«é–¢ã™ã‚‹å­¦ç¿’æŒ‡å°è¦é ˜ã®åŸºæº–ã«å‰‡ã£ã¦ã€æ–‡ç« ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
                3. è©•ä¾¡ã¯ä»¥ä¸‹ã®3æ®µéšã§è¡Œã£ã¦ãã ã•ã„ã€‚
                   - Sï¼šé¸æŠã—ãŸå­¦å¹´ã‚ˆã‚Šã‚‚é«˜ã„å­¦å¹´ã®åŸºæº–ã«é”ã—ã¦ã„ã‚‹
                   - Aï¼šé¸æŠã—ãŸå­¦å¹´ã®åŸºæº–ã«é”ã—ã¦ã„ã‚‹
                   - Bï¼šé¸æŠã—ãŸå­¦å¹´ã®åŸºæº–ã«é”ã—ã¦ã„ãªã„
                4. è©•ä¾¡ã®æ ¹æ‹ ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚å­ã©ã‚‚ãŒç†è§£ã—ã‚„ã™ã„ã‚ˆã†ã«ã€é›£ã—ã„è¨€è‘‰ã‚„å°‚é–€ç”¨èªï¼ˆä¾‹ï¼šã€Œå­¦ç¿’æŒ‡å°è¦é ˜ã€ã€Œæ–‡æ³•ã€ã€Œä¿®é£¾èªã€ãªã©ï¼‰ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚ä»£ã‚ã‚Šã«ã€ã€Œæ–‡ã®ã¾ã¨ã¾ã‚Šæ–¹ã€ã€Œè¨€è‘‰ã®é¸ã³æ–¹ã€ã€Œæ°—æŒã¡ã®è¡¨ç¾ã€ãªã©ã®ã€å­ã©ã‚‚ã«å¯„ã‚Šæ·»ã£ãŸè¨€è‘‰ã§å…·ä½“çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
                5. è©•ä¾¡çµæœã¯ã€è©•ä¾¡ï¼ˆS/A/Bï¼‰ã¨ã€ãã®ç†ç”±ã€å­ä¾›ã®é ‘å¼µã‚Šã‚’è¤’ã‚ã‚‹åŠ±ã¾ã—ã®è¨€è‘‰ã€ãã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ã¤ãªãŒã‚‹å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
                6. ã‚‚ã—æ–‡ç« ã«ä»¥ä¸‹ã®è¡¨ç¾æŠ€æ³•ãŒä½¿ã‚ã‚Œã¦ã„ãŸã‚‰ã€ãã®é ‘å¼µã‚Šã‚’ç‰¹ã«è¤’ã‚ã¦ã‚ã’ã¦ãã ã•ã„ã€‚
                   - æ“¬éŸ³èªãƒ»æ“¬æ…‹èªï¼ˆä¾‹ï¼šãƒ¯ãƒ³ãƒ¯ãƒ³ã€ãµã‚ãµã‚ï¼‰
                   - ç›´å–©ï¼ˆæ¯”å–©ï¼‰ï¼ˆä¾‹ï¼šã¾ã‚‹ã§æ°·ã®ã‚ˆã†ã«å†·ãŸã„ï¼‰
                   - æ“¬äººåŒ–ï¼ˆä¾‹ï¼šèŠ±ãŒå–œã‚“ã§è¸Šã£ã¦ã„ã‚‹ï¼‰
                   - æƒ…æ™¯æå†™ï¼ˆä¾‹ï¼šå¤•æ—¥ãŒç©ºã‚’ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã«æŸ“ã‚ã¦ã„ãï¼‰
                7. **ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®æ–‡ç« ã¯ã€å­ã©ã‚‚ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«å·¥å¤«ã—ã¦ãã ã•ã„ã€‚**
                   - **1ãƒ»2å¹´ç”Ÿå‘ã‘**ï¼šåŸºæœ¬çš„ãªæ¼¢å­—ä»¥å¤–ã¯ã²ã‚‰ãŒãªã‚’å¤šãä½¿ã£ã¦ãã ã•ã„ã€‚å…¨ä½“çš„ã«ã²ã‚‰ãŒãªã‚’å¤šãã—ã€ã‚„ã•ã—ã„è¨€è‘‰ã§è©±ã—ã‹ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
                   - **3å¹´ç”Ÿä»¥ä¸Šå‘ã‘**ï¼šãã®å­¦å¹´ã§ç¿’ã†æ¼¢å­—ã‚„å°‘ã—é›£ã—ã„è¨€è‘‰ã«ã€<ruby>æ¼¢å­—<rt>ã‹ã‚“ã˜</rt></ruby>ã®ã‚ˆã†ã«ã€æ–‡å­—ã®ä¸Šã«ãµã‚ŠãŒãªï¼ˆãƒ«ãƒ“ï¼‰ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚
                   - å…¨å­¦å¹´å…±é€šã§ã€å­ã©ã‚‚ã«å¯„ã‚Šæ·»ã£ãŸã€ã‚„ã•ã—ã„æ–‡ç« ã«ãªã‚‹ã‚ˆã†ã«å·¥å¤«ã—ã¦ãã ã•ã„ã€‚
                8. è©•ä¾¡æ–‡ã§ã¯ã€å­ä¾›ã®åå‰ã‚’ç‰¹å®šã™ã‚‹ã‚ˆã†ãªè¡¨ç¾ã¯ä¸€åˆ‡ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
                9. è©•ä¾¡ã®ç†ç”±ã‚’3æ–‡ç¨‹åº¦ã«çŸ­ãã€ç°¡æ½”ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
                10. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ã¤ãªãŒã‚‹å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®å¾Œã€ãã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã«åˆã£ãŸå…·ä½“çš„ãªä¾‹æ–‡ã‚’2ã¤ã€"examples"ã¨ã„ã†é…åˆ—ã«æ ¼ç´ã—ã¦ç¤ºã—ã¦ãã ã•ã„ã€‚
                11. æ–‡ç« ä¸­ã‹ã‚‰ã€Œã‚­ãƒ©ã‚­ãƒ©ãƒ¯ãƒ¼ãƒ‰ã€ï¼ˆæ¯”å–©ã€æ“¬éŸ³èªã€æ“¬æ…‹èªãªã©ã€æ–‡ç« ã‚’ç´ æ•µã«ã™ã‚‹è¡¨ç¾ï¼‰ã‚’è¦‹ã¤ã‘ãŸã‚‰ã€ãã®å˜èªã¨ã€ãã®å˜èªãŒä½¿ã‚ã‚Œã¦ã„ã‚‹æ–‡è„ˆï¼ˆçŸ­ã„ä¸€æ–‡ï¼‰ã‚’ã‚»ãƒƒãƒˆã§æŠ½å‡ºã—ã€"kirakira_words"ã«æ ¼ç´ã—ã¦ãã ã•ã„ã€‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç©ºã®é…åˆ—ã«ã—ã¦ãã ã•ã„ã€‚
                12. **ã„ã‹ãªã‚‹å ´åˆã§ã‚‚ã€å¿…ãšæŒ‡å®šã•ã‚ŒãŸJSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦å¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚** è©•ä¾¡ãŒé›£ã—ã„å ´åˆã§ã‚‚ã€JSONæ§‹é€ ã‚’ç¶­æŒã—ã€ãã®æ—¨ã‚’evaluationãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

                # JSONã‚¹ã‚­ãƒ¼ãƒ
                {
                  "score": "S" | "A" | "B",
                  "evaluation": "æ–‡ç« ã®è©•ä¾¡ç†ç”±ã‚’å…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚",
                  "encouragement": "é ‘å¼µã‚Šã‚’è¤’ã‚ã‚‹è¨€è‘‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚",
                  "next_step": "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ã¤ãªãŒã‚‹å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚",
                  "examples": ["ä¾‹æ–‡1", "ä¾‹æ–‡2"],
                  "kirakira_words": [
                    { "word": "æŠ½å‡ºã—ãŸã‚­ãƒ©ã‚­ãƒ©ãƒ¯ãƒ¼ãƒ‰", "context": "ãã®ãƒ¯ãƒ¼ãƒ‰ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹æ–‡è„ˆ" }
                  ]
                }
                
                # å­¦å¹´
                ${grade}
                
                # æ–‡ç« 
                ${text}
                
                # å‚è€ƒè³‡æ–™
                ${curriculumContent}
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "score": { "type": "STRING", "enum": ["S", "A", "B"] },
                                "evaluation": { "type": "STRING" },
                                "encouragement": { "type": "STRING" },
                                "next_step": { "type": "STRING" },
                                "examples": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "kirakira_words": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "word": { "type": "STRING" },
                                            "context": { "type": "STRING" }
                                        },
                                        "required": ["word", "context"]
                                    }
                                }
                            },
                            "required": ["score", "evaluation", "encouragement", "next_step", "examples", "kirakira_words"]
                        }
                    }
                };

                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                let response;
                let result;
                let retries = 0;
                const maxRetries = 3;
                let success = false;
                while (retries < maxRetries && !success) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        result = await response.json();
                        if (response.status === 429) {
                            retries++;
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        success = true;
                    } catch (error) {
                        retries++;
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                if (success && result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    let feedback;
                    // â˜…â˜…â˜… JSONãƒ‘ãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ– â˜…â˜…â˜…
                    try {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        feedback = JSON.parse(jsonString);
                    } catch (parseError) {
                        console.error("JSON Parse Error:", parseError);
                        // ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                        const corruptedFeedback = { score: "B", evaluation: "ã”ã‚ã‚“ãªã•ã„ã€‚AIã›ã‚“ã›ã„ãŒã€ã¡ã‚‡ã£ã¨ã‚ãšã‚‰ã—ã„ã¶ã‚“ã—ã‚‡ã†ã§ã€ã³ã£ãã‚Šã—ã¡ã‚ƒã£ãŸã¿ãŸã„ã€‚ã‚‚ã†ã„ã¡ã©ã€ã¶ã‚“ã—ã‚‡ã†ã‚’ã‹ã„ã¦ã¿ã¦ã­ã€‚", encouragement: "ã¶ã‚“ã—ã‚‡ã†ã‚’ã‹ã„ã¦ãã‚ŒãŸã“ã¨ã€ã›ã‚“ã›ã„ã¯ã¨ã¦ã‚‚ã†ã‚Œã—ã„ã‚ˆï¼", next_step: "ã‚‚ã†ã„ã¡ã©ã€ã€Œã“ã“ã§ãƒã‚§ãƒƒã‚¯ï¼ã€ã‚’ãŠã—ã¦ã¿ã¦ãã‚Œã‚‹ã‹ãªã€‚", examples: [], kirakira_words: [] };
                        displayFeedback(corruptedFeedback, originalText);
                        return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
                    }


                    const isCorrupted = (text) => {
                        const repetitionRegex = /(\p{sc=Han})\1/u;
                        return text && repetitionRegex.test(text);
                    };

                    if (isCorrupted(feedback.evaluation) || isCorrupted(feedback.encouragement) || isCorrupted(feedback.next_step)) {
                        const corruptedFeedback = { score: "B", evaluation: "ã”ã‚ã‚“ãªã•ã„ã€‚ã†ã¾ãè©•ä¾¡ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã€æ–‡ç« ã‚’æ›¸ã„ã¦ã¿ã¦ã­ã€‚", encouragement: "ã‚ãªãŸãŒæ–‡ç« ã‚’æ›¸ã„ã¦ãã‚ŒãŸã“ã¨ãŒã€å…ˆç”Ÿã¯ã¨ã¦ã‚‚ã†ã‚Œã—ã„ã‚ˆï¼", next_step: "ã‚‚ã†ä¸€åº¦ã€ã€Œã“ã“ã§ãƒã‚§ãƒƒã‚¯ï¼ã€ã‚’æŠ¼ã—ã¦ã¿ã¦ãã‚Œã‚‹ã‹ãªã€‚", examples: [], kirakira_words: [] };
                        displayFeedback(corruptedFeedback, originalText);
                        return;
                    }

                    displayFeedback(feedback, originalText);
                    
                    if (feedback.kirakira_words && feedback.kirakira_words.length > 0) {
                        let newWordsCount = 0;
                        feedback.kirakira_words.forEach(item => {
                            if (saveKirakiraWord(item.word, item.context)) {
                                newWordsCount++;
                            }
                        });
                        if (newWordsCount > 0) {
                            setTimeout(() => {
                                showMessage(`æ–°ã—ã„ã‚­ãƒ©ã‚­ãƒ©ãƒ¯ãƒ¼ãƒ‰ã‚’${newWordsCount}å€‹ã‚²ãƒƒãƒˆã—ãŸã‚ˆï¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¦ã¿ã‚ˆã†ï¼`, "ğŸ‰ ã‚„ã£ãŸã­ï¼");
                            }, 500);
                        }
                    }

                } else {
                    const fallbackFeedback = { score: "B", evaluation: "ã”ã‚ã‚“ãªã•ã„ã€‚ã†ã¾ãè©•ä¾¡ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã€æ–‡ç« ã‚’æ›¸ã„ã¦ã¿ã¦ã­ã€‚", encouragement: "ã‚ãªãŸãŒæ–‡ç« ã‚’æ›¸ã„ã¦ãã‚ŒãŸã“ã¨ãŒã€å…ˆç”Ÿã¯ã¨ã¦ã‚‚ã†ã‚Œã—ã„ã‚ˆï¼", next_step: "ã‚‚ã†ä¸€åº¦ã€ã€Œã“ã“ã§ãƒã‚§ãƒƒã‚¯ï¼ã€ã‚’æŠ¼ã—ã¦ã¿ã¦ãã‚Œã‚‹ã‹ãªã€‚", examples: [], kirakira_words: [] };
                    displayFeedback(fallbackFeedback, originalText);
                }

            } catch (e) {
                console.error(e);
                const errorFeedback = { score: "B", evaluation: "ã”ã‚ã‚“ãªã•ã„ã€‚è©•ä¾¡ä¸­ã«å•é¡ŒãŒèµ·ãã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã€æ–‡ç« ã‚’æ›¸ã„ã¦ã¿ã¦ã­ã€‚", encouragement: "ã‚ãªãŸãŒæ–‡ç« ã‚’æ›¸ã„ã¦ãã‚ŒãŸã“ã¨ãŒã€å…ˆç”Ÿã¯ã¨ã¦ã‚‚ã†ã‚Œã—ã„ã‚ˆï¼", next_step: "ã‚‚ã†ä¸€åº¦ã€ã€Œã“ã“ã§ãƒã‚§ãƒƒã‚¯ï¼ã€ã‚’æŠ¼ã—ã¦ã¿ã¦ãã‚Œã‚‹ã‹ãªã€‚", examples: [], kirakira_words: [] };
                displayFeedback(errorFeedback, originalText);
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = `ã“ã“ã§ãƒã‚§ãƒƒã‚¯ï¼`;
            }
        });

        function displayFeedback(feedback, originalText) {
            const evaluation = feedback.evaluation !== undefined ? feedback.evaluation : "è©•ä¾¡ã®ç†ç”±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            const encouragement = feedback.encouragement !== undefined ? feedback.encouragement : "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            const nextStep = feedback.next_step !== undefined ? feedback.next_step : "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            const examples = feedback.examples !== undefined ? feedback.examples : [];
            
            let examplesHtml = '';
            if (examples.length > 0) {
                examplesHtml = `<div class="mt-4">
                                    <h5 class="text-md font-bold text-pink-600">ãŸã¨ãˆã°ã“ã‚“ãªæ–‡</h5>
                                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                                        ${examples.map(ex => `<li>${ex}</li>`).join('')}
                                    </ul>
                                   </div>`;
            }

            const grade = parseInt(gradeSelect.value, 10);
            let heading1, heading2, heading3;

            if (grade <= 2) {
                heading1 = 'ã²ã‚‡ã†ã‹ã®ã‚Šã‚†ã†';
                heading2 = 'ã›ã‚“ã›ã„ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
                heading3 = 'ã¤ãã®ã‚¹ãƒ†ãƒƒãƒ—';
            } else {
                heading1 = '<ruby>è©•ä¾¡<rt>ã²ã‚‡ã†ã‹</rt></ruby>ã®<ruby>ç†ç”±<rt>ã‚Šã‚†ã†</rt></ruby>';
                heading2 = '<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
                heading3 = '<ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã®ã‚¹ãƒ†ãƒƒãƒ—';
            }

            feedbackContent.innerHTML = `
                <div class="flex items-center space-x-4 mb-4">
                    <span class="text-4xl font-extrabold px-4 py-2 rounded-full text-white ${feedback.score === 'S' ? 'bg-green-500' : feedback.score === 'A' ? 'bg-blue-500' : 'bg-yellow-500'}">
                        ${feedback.score}
                    </span>
                </div>
                <div class="mb-4">
                    <h4 class="text-lg font-bold text-gray-800">${heading1}</h4>
                    <p class="text-gray-600">${evaluation}</p>
                </div>
                <div class="mb-4">
                    <h4 class="text-lg font-bold text-gray-800">${heading2}</h4>
                    <p class="text-gray-600">${encouragement}</p>
                </div>
                <div class="mb-4">
                    <h4 class="text-lg font-bold text-gray-800">${heading3}</h4>
                    <p class="text-gray-600">${nextStep}</p>
                    ${examplesHtml}
                </div>
            `;

            resultArea.classList.remove('hidden');
            feedbackContent.className = `feedback-box ${feedback.score === 'S' ? 'bg-green-100 text-green-800' : feedback.score === 'A' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}`;
        }
        
        function loadKirakiraCollection() {
            try {
                const collectionJSON = localStorage.getItem('kirakiraCollection');
                return collectionJSON ? JSON.parse(collectionJSON) : [];
            } catch (e) {
                console.error("Failed to parse kirakiraCollection from localStorage", e);
                return [];
            }
        }
        
        function saveKirakiraWord(word, context) {
            if (!word || !context) return false;
            let collection = loadKirakiraCollection();
            const isAlreadyCollected = collection.some(item => item.word === word);
            if (!isAlreadyCollected) {
                collection.push({ word, context });
                localStorage.setItem('kirakiraCollection', JSON.stringify(collection));
                return true;
            }
            return false;
        }

        function showCollectionModal() {
            const collection = loadKirakiraCollection();
            collectionGrid.innerHTML = '';

            if (collection.length === 0) {
                collectionGrid.innerHTML = '<p class="text-gray-500">ã¾ã ã‚­ãƒ©ã‚­ãƒ©ãƒ¯ãƒ¼ãƒ‰ãŒé›†ã¾ã£ã¦ã„ãªã„ã‚ˆã€‚ä½œæ–‡ã‚’æ›¸ã„ã¦è¦‹ã¤ã‘ã‚ˆã†ï¼</p>';
            } else {
                collection.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'collection-card';
                    card.innerHTML = `
                        <div class="collection-word">${item.word}</div>
                        <div class="collection-context">ã€Œ${item.context}ã€ã§ä½¿ã£ãŸã­ï¼</div>
                    `;
                    collectionGrid.appendChild(card);
                });
            }
            collectionModal.classList.add('is-visible');
        }

        function hideCollectionModal() {
            collectionModal.classList.remove('is-visible');
        }

        collectionButton.addEventListener('click', showCollectionModal);
        closeCollectionModalButton.addEventListener('click', hideCollectionModal);
        collectionModal.addEventListener('click', (e) => {
            if (e.target === collectionModal) {
                hideCollectionModal();
            }
        });
    });
</script>

</body>
</html>
